<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Palmu ランク管理ツール(れみたん用です)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app">
    <header style="margin-bottom: 10px;">
      <h1>
        Palmu ランク管理
        <span class="pill">7日間＋数トラッカー</span>
      </h1>
          <!-- ライブ中計算機 -->
    <section class="card" id="liveCalcCard" style="margin-bottom: 12px;">
      <div class="card-header">
        <div>
          <div class="card-title">ライブ中計算機</div>
          <div class="card-sub">
            現在のランクと狙う＋（2/4/6）を選んで、<br>
            配信中のライブスコアから「あと何スコア・何コイン必要か」を計算します。
          </div>
        </div>
        <span class="pill">現在ランク: <span id="liveCalcRankLabel">-</span></span>
      </div>

      <div class="grid" style="gap: 8px;">
        <div>
          <label for="calcPlusSelect">目標＋</label>
          <select id="calcPlusSelect">
            <option value="2">＋2</option>
            <option value="4">＋4</option>
            <option value="6">＋6</option>
          </select>
          <div class="text-small">
            ※基本設定の「現在のランク」でボーダーを切り替えます。
          </div>
        </div>

        <div>
          <label>このランクのボーダー</label>
          <div class="stat-row">
            <div class="stat-label">必要ライブスコア</div>
            <div class="stat-value">
              <span id="calcTargetScore" class="stat-highlight">-</span>
            </div>
          </div>
          <div class="text-small">
            ※Palmuの＋2/4/6ボーダーをそのまま表示しています。
          </div>
        </div>
      </div>

      <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 10px 0;">

      <div class="grid" style="gap: 8px;">
        <div>
          <label for="calcCurrentScore">現在のライブスコア</label>
          <input id="calcCurrentScore" type="number" min="0" placeholder="例: 125000" />
        </div>

        <div>
          <label>差分＆必要コイン</label>
          <div class="stat-row">
            <div class="stat-label">あと必要スコア</div>
            <div class="stat-value">
              <span id="calcRemainingScore">-</span>
            </div>
          </div>
          <div class="stat-row">
            <div class="stat-label">目安コイン数（1/3換算）＊最低10コイン単位に修正しました</div>
            <div class="stat-value">
              <span id="calcRequiredCoins" class="coin-text">-</span>
            </div>
          </div>
          <div class="text-small">
            スコア差分 ÷ 3 を切り上げて計算しています。誤差はご愛嬌。
          </div>
        </div>
      </div>
    </section>

  <!-- 跳ねカウント -->
  <section class="card" id="haneCard" style="margin-bottom: 12px;">
    <div class="card-header">
      <div>
        <div class="card-title">跳ねカウント</div>
        <div class="card-sub">
          秒数だけをカウントして表示します。<br>
          50〜59秒のときは少し大きく光らせます。
        </div>
      </div>
    </div>

    <div class="hane-main">
      <!-- 左：秒数表示 -->
      <div class="hane-display-wrapper">
        <div id="haneSecondDisplay" class="hane-display">00</div>
      </div>

    <!-- 右：イラスト -->
      <div class="hane-illust-wrapper">
        <img
          src="img/hane-chara.png"
          alt="跳ねカウントアイコン"
          class="hane-illust"
        />
      </div>
    </div>
  </section>

    

      <div class="subtitle">
        7日間の<b>＋数合計</b>から<b>ランクアップ / キープ / ダウン</b>を判定しつつ、<br />
        「今週の目標（UP or KEEP）」と「日ごとの＋計画」「今日のノルマ」まで見える化します。
      </div>
    </header>

    <!-- ダッシュボード & 設定 -->
    <section class="grid grid-2" style="margin-bottom: 16px;">
      <!-- ダッシュボード -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">現在の状況</div>
            <div class="card-sub">7日間の＋合計・判定・今日のノルマ</div>
          </div>
          <div id="currentRankBadges">
            <!-- 現在ランク / 次ランク バッジ -->
          </div>
        </div>

        <div class="stat-row">
          <div class="stat-label">7日間＋数合計</div>
          <div class="stat-value stat-highlight"><span id="sum7">0</span> pt</div>
        </div>

        <div class="stat-row">
          <div class="stat-label">この7日間の期間</div>
          <div class="stat-value">
            <span id="periodStart">-</span> 〜 <span id="periodEnd">-</span>
          </div>
        </div>

        <div class="progress">
          <div id="progressBar" class="progress-bar"></div>
        </div>

        <div style="margin-top: 10px;">
          <div class="stat-row">
            <div class="stat-label" id="upConditionLabel">ランクアップ条件（18pt以上）</div>
            <div class="stat-value">
              あと <span id="needUpPoints">18</span> pt
            </div>
          </div>
          <div class="stat-row">
            <div class="stat-label" id="keepConditionLabel">キープ条件（12pt以上）</div>
            <div class="stat-value">
              あと <span id="needKeepPoints">12</span> pt
            </div>
          </div>
          <div class="stat-row">
            <div class="stat-label">ダウン回避までの余裕</div>
            <div class="stat-value">
              <span id="safeMarginPoints">-</span>
            </div>
          </div>
          <div class="stat-row">
            <div class="stat-label">現在の判定</div>
            <div class="stat-value">
              <span id="statusBadge" class="badge badge-keep">データ不足</span>
            </div>
          </div>

          <div class="stat-row">
            <div class="stat-label">今日の目安（目標に対して）</div>
            <div class="stat-value">
              <span id="todayTargetPt">-</span><br />
              <span id="todayTargetCoins">-</span>
            </div>
          </div>
        </div>

        <div class="chips">
          <span class="chip">UP: 7日合計 <span id="chipUpThreshold">18</span>pt以上</span>
          <span class="chip">KEEP: <span id="chipKeepThreshold">12</span>〜UP未満</span>
          <span class="chip">DOWN: <span id="chipDownThreshold">11</span>pt以下</span>
        </div>

        <div class="text-small" style="margin-top: 6px;">
          ※終了日は「開始日 or 最新入力日」＋ スキップ日数です。<br />
          その終了日からさかのぼって7日間を集計しています。
        </div>
      </div>

      <!-- 設定 -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">基本設定</div>
            <div class="card-sub">ランク・目標・期間・スキップ</div>
          </div>
        </div>

        <div style="display: grid; gap: 8px;">
          <div>
            <label for="currentRank">現在のランク</label>
            <select id="currentRank"></select>
            <div class="text-small">
              ※現在のランクに応じて変更。
            </div>
          </div>

          <div>
            <label for="goalType">今週の目標</label>
            <select id="goalType">
              <option value="UP">ランクアップ狙い</option>
              <option value="KEEP">ランクキープ狙い</option>
            </select>
            <div class="text-small">
              ここで「UP / KEEP」を選ぶと、目標ptとノルマ計算に反映されます。
            </div>
          </div>

          <div>
            <label for="periodStartInput">7日間の開始日</label>
            <input id="periodStartInput" type="date" />
            <div class="text-small">
              この日から7日間を「1週」として計画 & 判定します。<br />
              未設定の場合は、最新入力日ベースで自動計算。
            </div>
          </div>

          <div>
            <label for="skipDays">スキップカード（枚数）</label>
            <input id="skipDays" type="number" min="0" max="7" step="1" />
            <div class="text-small">
              スキップカード1枚 = 1日遅延なので「1」。<br />
              0ならスキップなしとして計算します。
            </div>
          </div>

          <div>
            <label>スキップカードを使う日（任意）</label>
            <div id="skipDatesContainer" class="skip-dates"></div>
            <div class="text-small">
              ※スキップ枚数ぶんだけ日付を指定できます。<br />
              判定期間の延長は「枚数」で計算しますが、ここで「どの日を飛ばすか」をメモしておけます。
            </div>
          </div>

          <div>
            <label>ランク概要</label>
            <div class="text-small">
              次のランク：<span id="nextRankLabel" class="muted">-</span><br />
              ひとつ下のランク：<span id="prevRankLabel" class="muted">-</span>
            </div>
          </div>
        </div>

        <button id="applySettings" class="btn btn-block" style="margin-top: 10px;">
          この設定で反映
        </button>
        <div class="text-small" style="margin-top: 4px;">
          ※ランク・目標・開始日・スキップを変更したら、このボタンでダッシュボードと計画を更新します。
        </div>
      </div>
    </section>

    <!-- 7日間の＋計画 -->
    <section class="card" style="margin-bottom: 16px;">
      <div class="card-header">
        <div>
          <div class="card-title">7日間の＋計画</div>
          <div class="card-sub">
            この週の「＋1 / 2 / 4 / 6」をどう配分するかを決めるエリア。<br />
            ＋3・＋5は存在しないので、選べるのは 0,1,2,4,6 のみ。
          </div>
        </div>
      </div>
    
      <table id="planTable">
        <thead>
          <tr>
            <th>日付</th>
            <th>計画＋</th>
            <th class="text-right">目安コイン</th>
            <th>メモ</th>
          </tr>
        </thead>
        <tbody id="planTableBody">
          <!-- JSで挿入 -->
        </tbody>
      </table>
    
      <div class="stat-row" style="margin-top: 6px;">
        <div class="stat-label">今週の目標</div>
        <div class="stat-value">
          <span id="goalTypeLabel">-</span> /
          目標 <span id="targetPlusLabel">-</span> pt
        </div>
      </div>
    
      <div class="stat-row">
        <div class="stat-label">計画合計</div>
        <div class="stat-value">
          <span id="planTotalPlus">0</span> pt
          （<span id="planMarginPlus">-</span>）
        </div>
      </div>
    
      <button id="recalcPlan" class="btn btn-block btn-secondary" style="margin-top: 8px;">
        今日までの実績から残り日を再配分
      </button>
      <div class="text-small" style="margin-top: 4px;">
        ※前半で目標に届かなかったときなどに、残りの日の計画を自動で組み直します。<br />
        期間内の日付に対して、今日より前は「実績」で固定し、今日以降で目標ptまで割り振り直します。
      </div>
    
      <div class="text-small" style="margin-top: 4px;">
        例）UP目標18ptに対して 6,6,2,1,1,1,1 のように組んで「合計18pt」とか。<br />
        計画はあとからいくらでも調整OKです。
      </div>
    </section>
    

    <!-- 入力フォーム -->
    <section class="card" style="margin-bottom: 16px;">
      <div class="card-header">
        <div>
          <div class="card-title">デイリー＋実績入力</div>
          <div class="card-sub">その日の実際の＋数・コイン・メモを記録</div>
        </div>
      </div>

      <form id="entryForm">
        <div style="display: grid; gap: 8px; margin-bottom: 6px;">
          <div class="input-row">
            <div>
              <label for="date">日付</label>
              <input id="date" type="date" required />
            </div>
            <div>
              <label for="drp">＋数（実績）</label>
              <select id="drp" required>
                <option value="1">＋1（配信つければ確定）</option>
                <option value="2">＋2</option>
                <option value="4">＋4</option>
                <option value="6">＋6</option>
              </select>
            </div>
          </div>
          <div class="input-row">
            <div>
              <label for="coins">その日に使われたコイン数（ざっくり）</label>
              <input id="coins" type="number" min="0" step="1" />
            </div>
            <div>
              <label for="hours">配信時間（任意）</label>
              <input id="hours" type="text" placeholder="例）2.5h / 3枠 など" />
            </div>
          </div>
          <div>
            <label for="memo">メモ（イベント名・特記事項など）</label>
            <textarea id="memo" placeholder="例）◯◯イベント最終日 / コラボ配信 など"></textarea>
          </div>
        </div>

        <button type="submit" class="btn btn-block">
          ＋ この日のデータを追加
        </button>
      </form>

      <div class="text-small" style="margin-top: 6px;">
        ※同じ日付を複数回登録してもOK（内部では合算して集計）。<br />
        配信しなかった日は入力しなくて大丈夫（＝＋0日）。
      </div>
    </section>

    <!-- 実績一覧 -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">入力済みデータ（新しい順 上位30件）</div>
          <div class="card-sub">
            7日間の集計は、開始日 or 最新入力日＋スキップ日数 から逆算して計算しています。
          </div>
        </div>
        <button id="clearAll" class="btn-sm danger">全部削除</button>
      </div>

      <table id="entriesTable">
        <thead>
          <tr>
            <th>日付</th>
            <th class="text-right">＋数</th>
            <th class="text-right">コイン</th>
            <th>メモ</th>
            <th class="text-right">操作</th>
          </tr>
        </thead>
        <tbody>
          <!-- JSで挿入 -->
        </tbody>
      </table>

      <div class="text-small" style="margin-top: 6px;">
        ※データは外部に保存されます。PC・スマホ・複数人で共有できます。
      </div>
    </section>
  </div>

  <!-- Firebase SDK（compat版） -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <!-- アプリ本体 -->
  <script src="app.js"></script>
</body>
</html>
